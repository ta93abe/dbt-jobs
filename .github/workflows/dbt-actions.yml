name: dbt Actions

on:
  workflow_call:
    inputs:
      mode:
        description: "Job mode: ci (build + PR comment), merge (build + artifacts), deploy (build + docs + artifacts)"
        required: true
        type: string
      dbt-adapter:
        description: "dbt adapter package name (e.g. dbt-bigquery)"
        required: true
        type: string
      dbt-command:
        description: "dbt command to run (e.g. 'dbt build', 'dbt build --select state:modified+ --defer --state ./prod-manifest')"
        required: false
        type: string
        default: "dbt build"
      dbt-version:
        description: "Explicit dbt-core version"
        required: false
        type: string
        default: ""
      python-version:
        description: "Python version"
        required: false
        type: string
        default: "3.11"
      project-dir:
        description: "Path to the dbt project root"
        required: false
        type: string
        default: "."
      target:
        description: "dbt target"
        required: false
        type: string
        default: ""
      prod-artifact-name:
        description: "Name of the artifact containing production manifest.json (ci mode only)"
        required: false
        type: string
        default: "dbt-artifacts"
      prod-branch:
        description: "Branch that produces production artifacts (ci mode only)"
        required: false
        type: string
        default: "main"
      post-pr-comment:
        description: "Post build results as a PR comment (ci mode only)"
        required: false
        type: boolean
        default: true
    secrets:
      profiles-yml:
        description: "Contents of profiles.yml"
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  dbt-actions:
    runs-on: ubuntu-latest
    steps:
      - name: Validate mode
        shell: bash
        run: |
          mode="${{ inputs.mode }}"
          if [[ "$mode" != "ci" && "$mode" != "merge" && "$mode" != "deploy" ]]; then
            echo "::error::Invalid mode '${mode}'. Must be one of: ci, merge, deploy"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup dbt
        uses: ta93abe/dbt-actions/actions/setup@main
        with:
          dbt-adapter: ${{ inputs.dbt-adapter }}
          dbt-version: ${{ inputs.dbt-version }}
          python-version: ${{ inputs.python-version }}
          profiles-yml: ${{ secrets.profiles-yml }}
          project-dir: ${{ inputs.project-dir }}

      - name: dbt deps
        uses: ta93abe/dbt-actions/actions/run@main
        with:
          command: dbt deps
          project-dir: ${{ inputs.project-dir }}
          target: ${{ inputs.target }}

      # ---- ci mode: download production manifest ----
      - name: Download production manifest
        if: inputs.mode == 'ci'
        id: download-manifest
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const artifactName = '${{ inputs.prod-artifact-name }}';
            const branch = '${{ inputs.prod-branch }}';

            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch,
              status: 'success',
              per_page: 5,
            });

            let artifact = null;
            for (const run of runs.data.workflow_runs) {
              const arts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id,
              });
              artifact = arts.data.artifacts.find(a => a.name === artifactName && !a.expired);
              if (artifact) break;
            }

            if (!artifact) {
              core.warning(`Artifact "${artifactName}" not found on branch "${branch}"`);
              core.setOutput('found', 'false');
              return;
            }

            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: artifact.id,
              archive_format: 'zip',
            });

            fs.writeFileSync('prod-manifest.zip', Buffer.from(download.data));
            core.setOutput('found', 'true');
        continue-on-error: true

      - name: Extract production manifest
        if: inputs.mode == 'ci' && steps.download-manifest.outputs.found == 'true'
        shell: bash
        run: |
          mkdir -p prod-manifest
          unzip -o prod-manifest.zip -d prod-manifest
          rm prod-manifest.zip

      # ---- ci mode: run dbt-command (manifest found) ----
      - name: "Run: ${{ inputs.dbt-command }}"
        id: dbt-build-slim
        if: inputs.mode == 'ci' && steps.download-manifest.outputs.found == 'true'
        uses: ta93abe/dbt-actions/actions/run@main
        with:
          command: ${{ inputs.dbt-command }}
          project-dir: ${{ inputs.project-dir }}
          target: ${{ inputs.target }}
        continue-on-error: true

      # ---- ci mode: fallback to dbt build (manifest not found) ----
      - name: "Run: dbt build (fallback)"
        id: dbt-build-full
        if: inputs.mode == 'ci' && steps.download-manifest.outputs.found != 'true'
        uses: ta93abe/dbt-actions/actions/run@main
        with:
          command: dbt build
          project-dir: ${{ inputs.project-dir }}
          target: ${{ inputs.target }}
        continue-on-error: true

      # ---- merge / deploy mode: run dbt-command ----
      - name: "Run: ${{ inputs.dbt-command }}"
        if: inputs.mode == 'merge' || inputs.mode == 'deploy'
        uses: ta93abe/dbt-actions/actions/run@main
        with:
          command: ${{ inputs.dbt-command }}
          project-dir: ${{ inputs.project-dir }}
          target: ${{ inputs.target }}

      # ---- deploy mode: docs generate ----
      - name: dbt docs generate
        if: inputs.mode == 'deploy'
        uses: ta93abe/dbt-actions/actions/run@main
        with:
          command: dbt docs generate
          project-dir: ${{ inputs.project-dir }}
          target: ${{ inputs.target }}

      # ---- merge / deploy mode: upload artifacts ----
      - name: Upload artifacts
        if: inputs.mode == 'merge' || inputs.mode == 'deploy'
        uses: actions/upload-artifact@v6
        with:
          name: dbt-artifacts
          path: |
            ${{ inputs.project-dir }}/target/manifest.json
            ${{ inputs.project-dir }}/target/run_results.json
          retention-days: 90

      # ---- ci mode: PR comment ----
      - name: Parse run results and comment on PR
        if: inputs.mode == 'ci' && inputs.post-pr-comment && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const projectDir = '${{ inputs.project-dir }}';
            const runResultsPath = path.join(projectDir, 'target', 'run_results.json');

            let body = '';
            const isSlim = '${{ steps.download-manifest.outputs.found }}' === 'true';
            const buildStep = isSlim ? '${{ steps.dbt-build-slim.outcome }}' : '${{ steps.dbt-build-full.outcome }}';
            const command = isSlim ? '${{ inputs.dbt-command }}' : 'dbt build';

            if (fs.existsSync(runResultsPath)) {
              const results = JSON.parse(fs.readFileSync(runResultsPath, 'utf8'));
              const stats = { pass: 0, warn: 0, error: 0, skip: 0 };
              for (const r of results.results) {
                const status = r.status.toLowerCase();
                if (status === 'pass' || status === 'success') stats.pass++;
                else if (status === 'warn') stats.warn++;
                else if (status === 'error' || status === 'fail') stats.error++;
                else stats.skip++;
              }
              const icon = stats.error > 0 ? ':x:' : ':white_check_mark:';
              const mode = isSlim ? `\`${command}\`` : `\`${command}\` (manifest not found)`;
              body = [
                `## ${icon} dbt Build Results`,
                '',
                `**Command:** ${mode}`,
                `| Status | Count |`,
                `|--------|-------|`,
                `| :white_check_mark: Pass | ${stats.pass} |`,
                `| :warning: Warn | ${stats.warn} |`,
                `| :x: Error | ${stats.error} |`,
                `| :fast_forward: Skip | ${stats.skip} |`,
                '',
                `<details><summary>Details</summary>`,
                '',
                '| Node | Status | Time |',
                '|------|--------|------|',
                ...results.results.map(r => {
                  const statusIcon = (r.status === 'pass' || r.status === 'success') ? ':white_check_mark:' : r.status === 'error' || r.status === 'fail' ? ':x:' : ':warning:';
                  return `| \`${r.unique_id}\` | ${statusIcon} ${r.status} | ${r.execution_time.toFixed(2)}s |`;
                }),
                '',
                '</details>',
              ].join('\n');
            } else {
              body = `## :warning: dbt Build\n\nNo run results found. Build status: **${buildStep}**`;
            }

            const marker = '<!-- dbt-actions-ci -->';
            body = `${marker}\n${body}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.startsWith(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      # ---- ci mode: propagate build failure ----
      - name: Check build result
        if: inputs.mode == 'ci'
        shell: bash
        run: |
          slim_outcome="${{ steps.dbt-build-slim.outcome }}"
          full_outcome="${{ steps.dbt-build-full.outcome }}"

          if [[ "$slim_outcome" == "failure" || "$full_outcome" == "failure" ]]; then
            echo "::error::dbt build failed"
            exit 1
          fi
