name: dbt Docs

on:
  workflow_call:
    inputs:
      dbt-adapter:
        description: "dbt adapter package name (e.g. dbt-bigquery)"
        required: true
        type: string
      dbt-version:
        description: "Explicit dbt-core version"
        required: false
        type: string
        default: ""
      python-version:
        description: "Python version"
        required: false
        type: string
        default: "3.11"
      project-dir:
        description: "Path to the dbt project root"
        required: false
        type: string
        default: "."
      target:
        description: "dbt target"
        required: false
        type: string
        default: ""
      deploy-to-gh-pages:
        description: "Deploy generated docs to GitHub Pages"
        required: false
        type: boolean
        default: false
      gh-pages-branch:
        description: "Branch to deploy GitHub Pages to"
        required: false
        type: string
        default: "gh-pages"
    secrets:
      profiles-yml:
        description: "Contents of profiles.yml"
        required: true

permissions:
  contents: write

jobs:
  dbt-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup dbt
        uses: ta93abe/dbt-actions/actions/setup@main
        with:
          dbt-adapter: ${{ inputs.dbt-adapter }}
          dbt-version: ${{ inputs.dbt-version }}
          python-version: ${{ inputs.python-version }}
          profiles-yml: ${{ secrets.profiles-yml }}
          project-dir: ${{ inputs.project-dir }}

      - name: dbt deps
        uses: ta93abe/dbt-actions/actions/run@main
        with:
          command: dbt deps
          project-dir: ${{ inputs.project-dir }}
          target: ${{ inputs.target }}

      - name: dbt docs generate
        uses: ta93abe/dbt-actions/actions/run@main
        with:
          command: dbt docs generate
          project-dir: ${{ inputs.project-dir }}
          target: ${{ inputs.target }}

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs
          path: |
            ${{ inputs.project-dir }}/target/index.html
            ${{ inputs.project-dir }}/target/manifest.json
            ${{ inputs.project-dir }}/target/catalog.json

      - name: Deploy to GitHub Pages
        if: inputs.deploy-to-gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ github.token }}
          publish_dir: ${{ inputs.project-dir }}/target
          publish_branch: ${{ inputs.gh-pages-branch }}
          keep_files: false
