name: dbt Slim CI

on:
  workflow_call:
    inputs:
      dbt-adapter:
        description: "dbt adapter package name (e.g. dbt-bigquery)"
        required: true
        type: string
      dbt-version:
        description: "Explicit dbt-core version"
        required: false
        type: string
        default: ""
      python-version:
        description: "Python version"
        required: false
        type: string
        default: "3.11"
      project-dir:
        description: "Path to the dbt project root"
        required: false
        type: string
        default: "."
      target:
        description: "dbt target"
        required: false
        type: string
        default: ""
      prod-artifact-name:
        description: "Name of the artifact containing production manifest.json"
        required: false
        type: string
        default: "dbt-artifacts"
      prod-branch:
        description: "Branch that produces production artifacts"
        required: false
        type: string
        default: "main"
      post-pr-comment:
        description: "Post build results as a PR comment"
        required: false
        type: boolean
        default: true
    secrets:
      profiles-yml:
        description: "Contents of profiles.yml"
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  dbt-slim-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup dbt
        uses: ta93abe/dbt-runner/actions/setup@main
        with:
          dbt-adapter: ${{ inputs.dbt-adapter }}
          dbt-version: ${{ inputs.dbt-version }}
          python-version: ${{ inputs.python-version }}
          profiles-yml: ${{ secrets.profiles-yml }}
          project-dir: ${{ inputs.project-dir }}

      - name: dbt deps
        uses: ta93abe/dbt-runner/actions/run@main
        with:
          command: dbt deps
          project-dir: ${{ inputs.project-dir }}
          target: ${{ inputs.target }}

      - name: Download production manifest
        id: download-manifest
        uses: dawidd6/action-download-artifact@v6
        with:
          name: ${{ inputs.prod-artifact-name }}
          branch: ${{ inputs.prod-branch }}
          path: prod-manifest
          if_no_artifact_found: warn
        continue-on-error: true

      - name: dbt build (slim)
        id: dbt-build
        if: steps.download-manifest.outcome == 'success'
        uses: ta93abe/dbt-runner/actions/run@main
        with:
          command: dbt build --select state:modified+ --defer --state ./prod-manifest
          project-dir: ${{ inputs.project-dir }}
          target: ${{ inputs.target }}
        continue-on-error: true

      - name: dbt build (full fallback)
        id: dbt-build-full
        if: steps.download-manifest.outcome != 'success'
        uses: ta93abe/dbt-runner/actions/run@main
        with:
          command: dbt build
          project-dir: ${{ inputs.project-dir }}
          target: ${{ inputs.target }}
        continue-on-error: true

      - name: Parse run results and comment on PR
        if: inputs.post-pr-comment && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const projectDir = '${{ inputs.project-dir }}';
            const runResultsPath = path.join(projectDir, 'target', 'run_results.json');

            let body = '';
            const isSlim = '${{ steps.download-manifest.outcome }}' === 'success';
            const buildStep = isSlim ? '${{ steps.dbt-build.outcome }}' : '${{ steps.dbt-build-full.outcome }}';

            if (fs.existsSync(runResultsPath)) {
              const results = JSON.parse(fs.readFileSync(runResultsPath, 'utf8'));
              const stats = { pass: 0, warn: 0, error: 0, skip: 0 };
              for (const r of results.results) {
                const status = r.status.toLowerCase();
                if (status === 'pass' || status === 'success') stats.pass++;
                else if (status === 'warn') stats.warn++;
                else if (status === 'error' || status === 'fail') stats.error++;
                else stats.skip++;
              }
              const icon = stats.error > 0 ? ':x:' : ':white_check_mark:';
              const mode = isSlim ? 'Slim CI (`state:modified+`)' : 'Full Build (manifest not found)';
              body = [
                `## ${icon} dbt Build Results`,
                '',
                `**Mode:** ${mode}`,
                `| Status | Count |`,
                `|--------|-------|`,
                `| :white_check_mark: Pass | ${stats.pass} |`,
                `| :warning: Warn | ${stats.warn} |`,
                `| :x: Error | ${stats.error} |`,
                `| :fast_forward: Skip | ${stats.skip} |`,
                '',
                `<details><summary>Details</summary>`,
                '',
                '| Node | Status | Time |',
                '|------|--------|------|',
                ...results.results.map(r => {
                  const statusIcon = (r.status === 'pass' || r.status === 'success') ? ':white_check_mark:' : r.status === 'error' || r.status === 'fail' ? ':x:' : ':warning:';
                  return `| \`${r.unique_id}\` | ${statusIcon} ${r.status} | ${r.execution_time.toFixed(2)}s |`;
                }),
                '',
                '</details>',
              ].join('\n');
            } else {
              body = `## :warning: dbt Build\n\nNo run results found. Build status: **${buildStep}**`;
            }

            // Update existing comment or create new one
            const marker = '<!-- dbt-runner-slim-ci -->';
            body = `${marker}\n${body}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.startsWith(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Check build result
        shell: bash
        run: |
          slim_outcome="${{ steps.dbt-build.outcome }}"
          full_outcome="${{ steps.dbt-build-full.outcome }}"

          if [[ "$slim_outcome" == "failure" || "$full_outcome" == "failure" ]]; then
            echo "::error::dbt build failed"
            exit 1
          fi
