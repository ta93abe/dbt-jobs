name: dbt CI

on:
  workflow_call:
    inputs:
      dbt-adapter:
        description: "dbt adapter package name (e.g. dbt-bigquery)"
        required: true
        type: string
      dbt-version:
        description: "Explicit dbt-core version"
        required: false
        type: string
        default: ""
      python-version:
        description: "Python version"
        required: false
        type: string
        default: "3.11"
      project-dir:
        description: "Path to the dbt project root"
        required: false
        type: string
        default: "."
      target:
        description: "dbt target"
        required: false
        type: string
        default: ""
      upload-artifacts:
        description: "Upload manifest.json and run_results.json as artifacts"
        required: false
        type: boolean
        default: false
      generate-docs:
        description: "Run dbt docs generate after build"
        required: false
        type: boolean
        default: false
    secrets:
      profiles-yml:
        description: "Contents of profiles.yml"
        required: true

jobs:
  dbt-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup dbt
        uses: ta93abe/dbt-actions/actions/setup@main
        with:
          dbt-adapter: ${{ inputs.dbt-adapter }}
          dbt-version: ${{ inputs.dbt-version }}
          python-version: ${{ inputs.python-version }}
          profiles-yml: ${{ secrets.profiles-yml }}
          project-dir: ${{ inputs.project-dir }}

      - name: dbt deps
        uses: ta93abe/dbt-actions/actions/run@main
        with:
          command: dbt deps
          project-dir: ${{ inputs.project-dir }}
          target: ${{ inputs.target }}

      - name: dbt build
        uses: ta93abe/dbt-actions/actions/run@main
        with:
          command: dbt build
          project-dir: ${{ inputs.project-dir }}
          target: ${{ inputs.target }}

      - name: dbt docs generate
        if: inputs.generate-docs
        uses: ta93abe/dbt-actions/actions/run@main
        with:
          command: dbt docs generate
          project-dir: ${{ inputs.project-dir }}
          target: ${{ inputs.target }}

      - name: Upload artifacts
        if: inputs.upload-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dbt-artifacts
          path: |
            ${{ inputs.project-dir }}/target/manifest.json
            ${{ inputs.project-dir }}/target/run_results.json
          retention-days: 90
